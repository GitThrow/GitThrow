<!doctype html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="utf-8">
  <title>Workbench</title>
  <link th:replace="user/project/fragment/project-page-content :: project-page-head" rel="stylesheet" type="text/css" />
  <link href="../../../static/css/diff.css" rel="stylesheet" type="text/css"
        th:href="@{/css/diff.css}"/>
</head>
<body class="skin-blue">
<div class="wrapper">

  <div th:replace="user/project/fragment/project-page-content :: project-page-topmenu" ></div>
  <div th:replace="user/project/fragment/project-page-content :: project-page-sidebar" ></div>


  <!-- content -->
  <div class="content-wrapper">

    <section class="content-header">
    </section>

    <section class="content">

      <!--/*@thymesVar id="pullRequest" type="net.orekyuu.workbench.controller.rest.model.PullRequestModel"*/-->
      <div class="box">
        <div class="box-header with-border">
          <h3 class="box-title" th:text="|#${pullRequest.number} ${pullRequest.title}|">タイトル</h3>
        </div>
        <div class="box-body">
          <div class="row">
            <!--/* 説明文 */-->
            <div id="desc" class="col-sm-8">
            </div>
            <!--/* 情報表示用のカラム */-->
            <div class="col-sm-4">
              <div class="form-group">
                <button id="merge" class="btn btn-primary" style="width: 100%" th:if="${!(pullRequest.conflict||pullRequest.closed)}">マージ</button>
                <button class="btn" style="width: 100%" disabled th:if="${pullRequest.closed}">マージ済み</button>
                <button class="btn" style="width: 100%" disabled th:if="${pullRequest.conflict}">コンフリクト</button>
              </div>
              <hr>
              <div class="form-group">
                <label class="control-label">作成者</label>
                <div th:text="${pullRequest.proponent}">admin</div>
              </div>

              <div class="form-group">
                <label class="control-label">レビュアー</label>
                <div th:text="${pullRequest.reviewer}">admin</div>
              </div>

              <div class="form-group">
                <label class="control-label">ベース</label>
                <div th:text="${pullRequest.baseBranch}">admin</div>
              </div>

              <div class="form-group">
                <label class="control-label">対象</label>
                <div th:text="${pullRequest.targetBranch}">admin</div>
              </div>

            </div>
          </div>

          <hr>
          <!--コメント-->
          <div id="comments"></div>

          <hr>
          <!--コメント送信フォーム-->
          <div class="row">
            <form action="" class="col-sm-12">
              <div class="form-group">
                <textarea class="form-control" rows="3" placeholder="コメントを入力 ..." id="comment-text"></textarea>
              </div>
              <div class="form-group">
                <button class="btn btn-success pull-right" id="comment-submit">送信</button>
              </div>
            </form>
          </div>

          <hr>
          <!--コード差分-->
          <div id="diff">
          </div>
        </div>
      </div>

    </section>
  </div><!-- end content -->


  <div th:replace="user/project/fragment/project-page-content :: project-page-footer" ></div>


</div><!-- end wrapper -->
<div th:replace="user/project/fragment/project-page-content :: project-page-script" ></div>
<!-- marked.js -->
<script src="../../../static/plugins/marked/marked.min.js" th:src="@{/plugins/marked/marked.min.js}"></script>
<script src="../../../static/js/highlight.pack.js" th:src="@{/js/highlight.pack.js}"></script>

<script th:inline="javascript">
  $(function () {
    function escapeHtml(str) {
      str = str.replace(/&/g, '&amp;');
      str = str.replace(/</g, '&lt;');
      str = str.replace(/>/g, '&gt;');
      str = str.replace(/"/g, '&quot;');
      str = str.replace(/'/g, '&#39;');
      return str;
    }

    //Diff
    var projectId = [[${projectId}]];
    var baseBranch = [[${pullRequest.baseBranch}]];
    var targetBranch = [[${pullRequest.targetBranch}]];
    var prNum = [[${pullRequest.number}]];

    var source = new EventSource("/rest/pull-request/diff?projectId=" + projectId + "&base=" + baseBranch + "&target=" + targetBranch, { withCredentials: true });
    source.onmessage = function(event) {
      var data = JSON.parse(event.data);
      var lines = data.lines;

      var diff = '<div class="file-diff">';
      var header = '<div class="file-diff-header">' + escapeHtml(data.fileName) + '</div>';
      diff += header;

      diff += '<div class="file-diff-content">';

      for (var i = 0; i < lines.length; i++) {
        var line = '<div class="line">';
        var gutter = '<div class="gutter">';
        gutter += '<div class="line-num line-num-a" >' + (lines[i].oldLineNum == -1 ? ' ' : + lines[i].oldLineNum) + '</div>';
        gutter += '<div class="line-num line-num-b" >' + (lines[i].newLineNum == -1 ? ' ' : + lines[i].newLineNum) + '</div>';
        gutter += '</div>';
        line += gutter;

        var color = '';
        if (lines[i].change === 'add') {
          color = 'line-add';
        }
        if (lines[i].change === 'delete') {
          color = 'line-remove';
        }

        var lineContent = '<pre class="line-content ' + color + '">' + escapeHtml(lines[i].content) + '</pre>';
        line += lineContent;
        line += '</div>';
        diff += line;
      }

      diff += '</div>';
      diff += '</div>';
      $('#diff').append(diff);
    };

    source.onerror = function (event) {
      source.close();
    };

    //marked.js
    marked.setOptions({
      sanitize:true,
      highlight: function(code, lang) {
        return hljs.highlightAuto(code, [lang]).value;
      }
    });
    $('#desc').html(marked([[${pullRequest.description}]]));

    //マージ
    $('#merge').click(function (e) {
      $('#merge').prop('disabled', true);

      var mergeEeventSource = new EventSource("/rest/job/merge?projectId=" + projectId + "&base=" + baseBranch + "&target=" + targetBranch + '&prNum=' + prNum, { withCredentials: true });
      mergeEeventSource.onerror = function (e) {
        mergeEeventSource.close();
      };
      window.location.href = '/project/' + projectId + '/pull-request/';
    });

    //コメント取得
    function updateComments() {
      var $comments = $('#comments');
      $comments.empty();
      fetchTicketComment([[${project.id}]], [[${pullRequest.number}]])
        .then(function (response) {
          _.chain(response.data).map(function (comment) {
            comment.text = marked(comment.text);
            comment.isSelf = comment.userId === /*[[${#authentication.principal.user.id}]]*/"hoge";
            return comment;
          }).map(function (comment) {
            var str = '<div class="direct-chat-msg ' + (comment.isSelf ? '' : 'right') + '">';
            str += '<div class="direct-chat-info clearfix">';
            str += '<span class="direct-chat-name pull-left">' + comment.userName + '(id: ' + comment.userId + ')</span>';
            str += '<span class="direct-chat-timestamp pull-right">' + comment.createdAt + '</span>';
            str += '</div>';
            str += '<img class="direct-chat-img" src="/user/icon/' + comment.userId + '">';
            str += '<div class="direct-chat-text">';
            str += comment.text;
            str += '</div>';
            str += '</div>';
            return str;
          }).each(function (comment) {
            $comments.append(comment);
          })
        }).catch(function (e) {
        console.log(e);
      });
    }

    updateComments();

    //コメント送信
    var $commentBtn = $('#comment-submit');
    var $commentText = $('#comment-text');
    $commentBtn.click(function () {
      $commentBtn.prop("disabled", true);
      $commentText.prop("disabled", true);

      createTicketComment([[${project.id}]], [[${pullRequest.number}]], $commentText.val())
        .then(function () {
          $commentBtn.prop("disabled", false);
          $commentText.prop("disabled", false);
          $commentText.val('');
          updateComments();
        }).catch(function (e) {
        $commentBtn.prop("disabled", false);
        $commentText.prop("disabled", false);
        console.log(e);
      });
    });
  });
</script>

</body>
</html>
